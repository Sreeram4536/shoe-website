<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
</head>
<body>
	<script type="application/x-javascript">
		addEventListener("load", function () {
			setTimeout(hideURLbar, 0);
		}, false);

		function hideURLbar() {
			window.scrollTo(0, 1);
		}
	</script>
	<!-- //custom-theme -->
	<link href="/css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
	<link rel="stylesheet" href="/css/shop.css" type="text/css" media="screen" property="" />
	<link href="/css/style7.css" rel="stylesheet" type="text/css" media="all" />
	<!-- Owl-carousel-CSS -->
	<link rel="stylesheet" type="text/css" href="/css/jquery-ui1.css">
	<link href="/css/style.css" rel="stylesheet" type="text/css" media="all" />
	<!-- font-awesome-icons -->
	<link href="/css/font-awesome.css" rel="stylesheet">
	<!-- //font-awesome-icons -->
	<link href="//fonts.googleapis.com/css?family=Montserrat:100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800"
	    rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800" rel="stylesheet">

	<style>
	.price-button {
		padding: 12px 20px;
		background-color: #f1f1f1;
		color: #333;
		border: 1px solid #ddd;
		border-radius: 30px;
		cursor: pointer;
		transition: background-color 0.3s, transform 0.2s;
		text-align: center;
		font-size: 14px;
	  }
	 
	 
	  .price-button:hover {
		background-color: #007bff;
		color: white;
		transform: scale(1.05);
	  }
	 
	 
	  .price-button:active {
		transform: scale(0.95);
	  }
	  /* .category-brand-container {
   text-align: center;
 } */
	  </style>
</head>

<body>
	<!-- banner -->
<div class="banner_top innerpage" id="home">
		<div class="wrapper_top_w3layouts">
			<div class="header_agileits">
				<div class="logo inner_page_log">
					<h1><a class="navbar-brand" href="index.html"><span>Downy</span> <i>Shoes</i></a></h1>
				</div>
				<div class="overlay overlay-contentpush">
					<button type="button" class="overlay-close"><i class="fa fa-times" aria-hidden="true"></i></button>

					<nav>
						<ul>
							<li><a href="/" class="active">Home</a></li>
							<li><a href="about.html">About</a></li>
							<li><a href="/user/shop">Shop Now</a></li>
							<li><a href="contact.html">Contact</a></li>
							
							
								<% if ((session && session.user) || (session && session.google)) { %>
									<li><a href="/user/cart">Cart</a></li>
									<li><a href="user/userProfile">Profile</a></li>
									<li><a href="user/logout">Logout</a></li>
								<% } else { %>
									<li><a href="user/signup">Signup</a></li>
									<li><a href="user/login">Login</a></li>
								<% } %>
						</ul>
					</nav>
				</div>
				<div class="mobile-nav-button">
					<button id="trigger-overlay" type="button"><i class="fa fa-bars" aria-hidden="true"></i></button>
				</div>
				<!-- cart details -->
				<div class="top_nav_right">
					<div class="shoecart shoecart2 cart cart box_1">
						<form action="#" method="post" class="last">
							<input type="hidden" name="cmd" value="_cart">
							<input type="hidden" name="display" value="1">
							<button class="top_shoe_cart" type="submit" name="submit" value=""><i class="fa fa-cart-arrow-down" aria-hidden="true"></i></button>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- //cart details -->
		<!-- search -->
		<div class="search_w3ls_agileinfo">
			<div class="cd-main-header">
				<ul class="cd-header-buttons">
					<li><a class="cd-search-trigger" href="#cd-search"> <span></span></a></li>
				</ul>
			</div>
			<div id="cd-search" class="cd-search">
				<form action="#" method="post">
					<input name="Search" type="search" placeholder="Click enter after typing...">
				</form>
			</div>
		</div>
		<!-- //search -->
		<div class="clearfix"></div>
		<!-- /banner_inner -->
		<div class="services-breadcrumb_w3ls_agileinfo">
			<div class="inner_breadcrumb_agileits_w3">

				<ul class="short">
					<li><a href="index.html">Home</a><i>|</i></li>
					<li>Shop</li>
				</ul>
			</div>
		</div>
		<!-- //banner_inner -->
	</div>
	<div class="container py-5">
		<div class="row">
			<div class="col-lg-8 mx-auto">
				<div class="card shadow">
					<div class="card-header bg-primary text-white text-center">
						<h3 class="mb-0">Your Cart</h3>
					</div>
					<div class="card-body">
						<% if ( cart.items.length ===0 ) { %>
							<!-- Display when the cart is empty -->
							<div class="text-center py-5" style="height: 50vh;">
								<p class="fs-4 text-muted">Your cart is empty.</p>
								<a href="/user/shop" class="btn btn-primary">Start Shopping</a>
							</div>
						<% } else { %>
							<!-- Display cart items -->
							<% cart.items.forEach(item => { %>
								<% if (item.productId) { %>
									<div class="d-flex align-items-center mb-3 border-bottom pb-3" style="height: 50vh;" id="cart-item-<%= item.productId._id %>">
										<img src="/uploads/product-images/<%= item.productId.productImage[0] %>" class="img-thumbnail rounded me-3" style="width: 100px; height: 100px;" alt="<%= item.productId.productName %>">
										<div class="flex-grow-1">
											<h5 class="mb-1"><%= item.productId.productName %></h5>
											<p class="mb-1 text-muted">Price: INR <strong><%= item.price %></strong></p>
											<button class="btn btn-outline-danger btn-sm remove-item" data-product-id="<%= item.productId._id %>">
												<i class="fas fa-trash-alt"></i> Remove
											</button>
										</div>
										<!-- <div class="ms-3">
											<input type="number" class="form-control quantity-input" 
												data-product-id="</%= item.productId._id %>" 
												value="</%= item.quantity %>" 
												min="1" max="</%= item.productId.quantity %>" required>
										</div> -->
										<div class="ms-3 d-flex align-items-center">
											<button class="btn btn-outline-secondary btn-sm btn-decrease" 
												data-product-id="<%= item.productId._id %>">-</button>
											
											<input type="number" class="form-control text-center quantity-input" 
												data-product-id="<%= item.productId._id %>" 
												value="<%= item.quantity %>" 
												min="1" max="<%= item.productId.quantity %>" 
												required readonly>
											
											<button class="btn btn-outline-secondary btn-sm btn-increase" 
												data-product-id="<%= item.productId._id %>">+</button>
										</div>

										
										<div class="ms-3 text-end">
											<p class="mb-0">Total:</p>
											<p class="mb-0 text-success fw-bold">INR <%= item.quantity * item.price %></p>
										</div>
									</div>
								<% } else { %>
									<div class="alert alert-warning" role="alert">
										Product details not available for one or more items.
									</div>
								<% } %>
							<% }); %>
							<div class="text-end mt-4">
								<h4 class="fw-bold">Total Price: INR <span class="text-primary"><%= totalCartPrice %></span></h4>
								<a href="/user/checkout" class="btn btn-success btn-lg mt-2">Proceed to Checkout</a>
							</div>
						<% } %>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
	<!-- Include SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<script>
		// Unified function to handle SweetAlert messages
		function showAlert(type, title, message) {
			Swal.fire({
				icon: type,
				title: title,
				text: message,
				showConfirmButton: type === 'error', // Show confirm button only for errors
				timer: type === 'success' ? 1500 : undefined // Auto close only for success
			}).then(() => {
				if (type === 'success') {
					location.reload();
				}
			});
		}
		
		// Function to add item to cart
		function addToCart(event, productId) {
    event.preventDefault();
    
    fetch(`/user/cart/add/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin' // Add this to ensure cookies/session are sent
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: data.message,
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Failed to add product to cart'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong while adding to cart!'
        });
    });

    return false;
}
		
		
		// Function to remove item from cart
		function removeFromCart(productId) {
			fetch('/user/cart/remove', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ productId })
			})
			.then(response => {
				if (response.ok) {
					// Remove the item from the UI
					document.getElementById(`cart-item-${productId}`).remove();
		
					// Check if the cart is empty
					const cartItems = document.querySelectorAll('.d-flex.align-items-center.mb-3.border-bottom.pb-3');
					if (cartItems.length === 0) {
						const cartBody = document.querySelector('.card-body');
						cartBody.innerHTML = `
							<div class="text-center py-5">
								<p class="fs-4 text-muted">Your cart is empty.</p>
								<a href="/shop" class="btn btn-primary">Start Shopping</a>
							</div>
						`;
					}
					showAlert('success', 'Success', 'Item removed from cart');
				} else {
					showAlert('error', 'Error', 'Failed to remove item');
				}
			})
			.catch(error => {
				showAlert('error', 'Error', 'Something went wrong!');
			});
		}

		// Event delegation for + and - buttons
		document.addEventListener('click', async (event) => {
			if (event.target.classList.contains('btn-increase') || event.target.classList.contains('btn-decrease')) {
				const button = event.target;
				const productId = button.getAttribute('data-product-id');
				const inputField = button.parentElement.querySelector('.quantity-input');
				let currentQuantity = parseInt(inputField.value);
				const maxQuantity = parseInt(inputField.getAttribute('max'));

				// Adjust quantity based on button type
				if (button.classList.contains('btn-increase')) {
					if (currentQuantity < maxQuantity) {
						currentQuantity++;
					} else {
						Swal.fire({
							icon: 'warning',
							title: 'Stock Limit Reached',
							text: `Only ${maxQuantity} items available in stock.`,
						});
						return;
					}
				} else if (button.classList.contains('btn-decrease')) {
					if (currentQuantity > 1) {
						currentQuantity--;
					} else {
						Swal.fire({
							icon: 'warning',
							title: 'Minimum Quantity Reached',
							text: 'Quantity cannot be less than 1.',
						});
						return;
					}
				}

				// Update the quantity visually
				inputField.value = currentQuantity;

				try {
					// Send updated quantity to backend
					const response = await fetch('/user/cart/update', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							product_id: productId,
							quantity: currentQuantity,
						}),
					});

					const result = await response.json();

					if (result.success) {
						Swal.fire({
							icon: 'success',
							title: 'Quantity Updated',
							text: result.message,
							timer: 1500,
							showConfirmButton: false,
						}).then(() => {
                    location.reload(); // Reload the cart page after the success message
                });
					} else {
						Swal.fire({
							icon: 'error',
							title: 'Update Failed',
							text: result.message,
						});
						// Revert quantity if update failed
						inputField.value = currentQuantity - 1; // Revert to previous value
					}
				} catch (error) {
					console.error('Error:', error);
					Swal.fire({
						icon: 'error',
						title: 'Server Error',
						text: 'Something went wrong. Please try again later.',
					});
				}
			}
		});

		// Add event listeners when document is ready
		document.addEventListener('DOMContentLoaded', function() {


		
		
			// Remove item event listeners
			document.querySelectorAll('.remove-item').forEach(button => {
				button.addEventListener('click', function() {
					const productId = this.getAttribute('data-product-id');
					removeFromCart(productId);
				});
			});
		});
	
	</script>

    

	<%- include("../partials/user/footer") %>
</body>
</html>